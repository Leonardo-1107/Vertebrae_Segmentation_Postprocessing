# README for Vertebrae Segmentation Refinement Pipeline

## Overview
This project is a **vertebra segmentation refinement pipeline**. It processes 3D segmentation outputs (in NIfTI format) generated by an initial prediction model, performs structural cleaning, hole-filling, smoothing, relabeling, and saves refined outputs both as a combined volume and as individual vertebrae.

The main script also supports **parallel execution** to speed up the refinement across multiple cases.

---

## Folder Structure

- **Input Folder**: `AbdomenAtlasDemoPredict/`
  - Contains subfolders for each case
  - Each subfolder must include a file named `combined_labels.nii.gz`

- **Output Folder**: `Refined/`
  - Will be automatically created if not existing
  - Each subfolder mirrors the input structure and contains the refined `combined_labels.nii.gz` and individual vertebra segmentations.

---

## How to Run

### Requirements
- Python 3.7+

Install all required packages via pip:

```bash
pip install numpy nibabel scipy tqdm scikit-image cc3d
```

--- 
## Usage

1.	Place your predicted segmentations into the folder AbdomenAtlasDemoPredict/, organized in subfolders, one subfolder per case.
2.	Run the script:
```bash
    python postprocessing_vertebrae.py
```

The script will automatically:

- Process each case in **parallel** (default up to 8 cases at a time)
- Clean the segmentation
- Fill holes
- Remove artifacts
- Correct mislabeled structures
- Save:
  - `combined_labels.nii.gz` (refined)
  - Individual vertebra files under the `segmentations/` folder

---  
## Major Processing Steps Explained

### 1. Reallocate Based on Size

```python
segmentation = reallocate_based_on_size(segmentation)
```

* Purpose: Detect and correct over-segmented (too large) or under-segmented (too small) vertebrae.

### 2. Adjacent Spine Smoothing
```python
segmentation = spine_adjacent_pairs(segmentation, voxel_supression_threshold=100)
```

* Purpose: Correct misassigned vertebral fragments between adjacent vertebrae.

### 3. Suppress Non-Largest Components
```python
segmentation = supress_non_largest_components(np.array(segmentation))
```

* Purpose: Remove small disconnected noise components for each vertebra label.